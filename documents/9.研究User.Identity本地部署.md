# 做法

此时回到了路径 D:\Code\1.microservice\2.netcore_microservice_userService\DeployCommon 去做继续开发

把各个微服务，用 docker-compose 的方式，本地部署上来

1. 对于日志 serilog ， flentd， elastic search， kibana 这一套应用一个 docker-compose 来部署
2. 对于 各个 apps 进行打包处理

## User.Identity

需要在 sln 目录执行构建命令

docker build -f User.Identity/Dockerfile -t user.identity:v1 .
会报很多错都是由于 Dockerfile 构建文件的问题了，

docker run -d -p 5103:80 -p 7024:445 --name user-identity user.identity:v1

## 容器可以运行起来，但是服务注册不到 consul

docker logs -f user-identity 看到启动时候报错

```
[HttpClient] 请求头中包含traceparent: True
fail: User.Identity.Services.ConsulRegistrationService[0]
      ❌ 注册服务到Consul失败: https://[::]:445
      System.Net.Http.HttpRequestException: Connection refused (127.0.0.1:8500)
```

注册 consul 服务时候报错
连接不上 consul，我现在的 consul 服务是用 exe 的方式在本机 windows 里 用 consul agent --dev 启动的，
这个问题是因为容器内的应用无法连接到宿主机的 Consul 服务。Docker 容器有自己独立的网络，127.0.0.1 在容器内指向容器自己，而不是宿主机

## 方案 1

修改 配置为，我不想这么做，没去尝试
"HttpEndpoint": "http://host.docker.internal:8500",

注册 consul 发送的健康检查过去不去，所以注册不到 consul 上

## 方案 2

线上 consul 不选用本地 exe 的方式应用，现在选用容器方式启动

## 当服务容器化，和 consul 容器化后，遇到一个核心问题

User.Identity 服务注册到 consul 时候遇到健康检查问题

代码得到的健康检查地址：
// 健康检查地址 - 使用 localhost，因为 Consul 在容器内访问
var healthCheckUrl = $"{scheme}://localhost:{port}/HealthCheck";

健康检查: https://localhost:445/HealthCheck⁠ ，
啊啊，那我大概理解了，此时 其实是 consul 容器内部要去做健康检查访问的地址，而这个地址是 https://localhost:445/HealthCheck⁠， 其实变成了 consul 容器去访问他自己 localhost 了，所以不会成功。

## 答案，完全正确！您这个理解非常到位，正是问题的核心所在。

localhost 在任何一个容器内都指向它自己。所以当 Consul 尝试访问 https://localhost:445/HealthCheck 时，它实际上是在自己的容器里寻找一个并不存在的服务。

## 方案

配置文件中修改配置，代码中去加载这个配置

```
"HealthCheck": {
      "Host": "user-identity", # 是user.identity的容器名字
      "Port": 80,
      "Path": "/HealthCheck"
    },
```

## 可以一直用这个命令打镜像

docker tag user.identity:v1 registry.cn-hangzhou.aliyuncs.com/microsoftservice/user.identity:v1
需要在 sln 目录执行构建命令

docker build -f User.Identity/Dockerfile -t registry.cn-hangzhou.aliyuncs.com/microsoftservice/user.identity:v1 .

docker-compose up -d user-identity

# 遗留问题

User.Identity 服务 80 和 455 端口为何都注册成功了呢，配置指定 https 真假，只注册一个端口才对呀
