# æ„å»ºæµ‹è¯•ç¨‹åº

dotnet new webapi -n helloworld --use-controllers

docker build -t helloworld:serilog_1 .
docker run -d -p 8080:80 -p 8444:444 --name serilogtest helloworld:serilog_1

## æŒ‡å®š log driver

docker run -d -p 8080:80 -p 8444:444 --name serilogtest_1 --log-driver=fluentd --log-opt fluentd-address=localhost:24224 helloworld:serilog_1

å¯è®¿é—®ï¼š
https://localhost:8444/WeatherForecast
https://localhost:8444/WeatherForecast/api/testlog

æ˜¯å¯ä»¥åœ¨ kibana ä¸­çœ‹åˆ° log ç»“æœçš„
http://localhost:5601/app/discover#/

# ç°åœ¨é›†æˆ Serilog

æ¥è¾“å‡ºç»“æ„åŒ–ã€æ˜“æŸ¥è¯¢çš„ JSON æ—¥å¿—æ˜¯ç»å¯¹æ­£ç¡®çš„é€‰æ‹©ï¼Œè¿™å°†æå¤§æå‡åœ¨ Kibana ä¸­çš„æ—¥å¿—åˆ†æä½“éªŒ

dotnet add package Serilog.Sinks.Console
dotnet add package Serilog.AspNetCore

# ğŸ”§ ï¼ˆå¯é€‰ï¼‰ç”Ÿäº§çº§å¢å¼ºé…ç½®

å¦‚æœä½ å¸Œæœ›å¯¹æ—¥å¿—çº§åˆ«ã€è¾“å‡ºæ¨¡æ¿ç­‰æœ‰æ›´ç²¾ç»†çš„æ§åˆ¶ï¼Œå¯ä»¥åœ¨ appsettings.json ä¸­æ·»åŠ  Serilog é…ç½®èŠ‚ã€‚é¦–å…ˆï¼Œè¯·ç¡®ä¿åœ¨é¡¹ç›®ä¸­å®‰è£…å¯é€‰åŒ…ï¼š

```
dotnet add package Serilog.Settings.Configuration
```

docker build -t helloworld:serilog-structured .
docker run -d -p 8080:80 -p 8444:444 --name serilog_structured_test --log-driver=fluentd --log-opt fluentd-address=localhost:24224 helloworld:serilog-structured

# é—®é¢˜

kibana ä¸­ä¸èƒ½å¾ˆå¿«æ‰¾åˆ° log çº§åˆ«ï¼Œå•ç‹¬æˆåˆ—

è¿™æ˜¯è¿™ç›´æ¥ postman æŸ¥è¯¢ ES å¾—åˆ°çš„è®°å½•

```
http://localhost:9200/fluentd-2025.12.21/_search?pretty
 {
                "_index": "fluentd-2025.12.21",
                "_id": "SKO0QJsB9C1BH-C6t-G9",
                "_score": 1.0,
                "_ignored": [
                    "log.keyword"
                ],
                "_source": {
                    "log": "{\"Timestamp\":\"2025-12-21T11:38:58.5478891+00:00\",\"Level\":\"Warning\",\"MessageTemplate\":\"è­¦å‘Šçº§åˆ«ï¼šè¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿè­¦å‘Š\",\"TraceId\":\"082db9623f30859db9cd8f10f7468c2d\",\"SpanId\":\"eb1bfc35880d19ba\",\"Properties\":{\"SourceContext\":\"helloworld.Controllers.WeatherForecastController\",\"ActionId\":\"cb9442d2-3b2d-4923-beea-331df78f6633\",\"ActionName\":\"helloworld.Controllers.WeatherForecastController.TestLog (helloworld)\",\"RequestId\":\"0HNI0FRVV05SP:00000001\",\"RequestPath\":\"/WeatherForecast/api/testlog\",\"ConnectionId\":\"0HNI0FRVV05SP\"}}",
                    "container_id": "cad31e3b529cd886d0817f2abb9eb3371004ac260983b7622d2d7a6f87e27d7e",
                    "container_name": "/serilog_structured_test",
                    "source": "stdout",
                    "hostname": "eab99972c779",
                    "service": "my_windows_app",
                    "@timestamp": "2025-12-21T11:38:58.000000000+00:00"
                }
            },
```

æ‚¨çš„ Fluentd é…ç½®æ²¡æœ‰é—®é¢˜ï¼Œä½†ä¸å®Œæ•´ã€‚å®ƒç¼ºå°‘äº†ä¸€ä¸ªæœ€å…³é”®çš„æ­¥éª¤ï¼šè§£ææ¥è‡ª Docker çš„ã€åŒ…è£¹åœ¨ log å­—æ®µä¸­çš„ JSON å­—ç¬¦ä¸²ã€‚

å› ä¸ºæ‚¨çš„æ—¥å¿—è™½ç„¶ä»¥ JSON æ ¼å¼è¾“å‡ºï¼Œä½† Docker çš„ fluentd é©±åŠ¨å°†å…¶ä½œä¸ºä¸€ä¸ªæ•´ä½“æ–‡æœ¬æ¶ˆæ¯å‘é€ï¼Œå¯¼è‡´åœ¨ Elasticsearch ä¸­å®ƒè¢«å­˜å‚¨ä¸ºä¸€ä¸ªåä¸º log çš„å­—ç¬¦ä¸²å­—æ®µã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ Level ç­‰å­—æ®µåœ¨ Kibana ä¸­â€œéšèº«â€äº†ã€‚

è¿™æ˜¯å› ä¸º flentd é…ç½®æ–‡ä»¶ å†³å®šçš„ï¼Œéœ€è¦ç ”ç©¶ fluent.conf æ–‡ä»¶çš„é…ç½®

```
<filter **>
  @type parser
  key_name log
  reserve_data true
  remove_key_name_field false
  <parse>
    @type json
  </parse>
</filter>
```

åŠ ä¸Šè¿™ä¸ªå work äº†

# docker run --rm --log-driver=fluentd --log-opt fluentd-address=localhost:24224 registry.cn-hangzhou.aliyuncs.com/abelcontainer/alpine:3.19.1 echo "ã€Docker é©±åŠ¨æµ‹è¯•ã€‘è¿™æ˜¯ä¸€æ¡é€šè¿‡å®¹å™¨æ ‡å‡†è¾“å‡ºç”Ÿæˆçš„æ—¥å¿—" è¿™ä¸ªæ–¹å¼çš„ æ—¥å¿—ï¼Œæ€ä¹ˆæ‰¾ä¸åˆ°äº†å‘¢

Fluentd çš„å¤„ç†æµç¨‹ï¼š

è¿™æ¡çº¯æ–‡æœ¬è¢« Docker é©±åŠ¨æ•è·ï¼Œæ”¾å…¥ log å­—æ®µå‘é€ç»™ Fluentdã€‚

æ—¥å¿—è¿›å…¥ \*\* è¿‡æ»¤å™¨é“¾ï¼Œç¬¬ä¸€ä¸ª record_transformer ä¸ºå®ƒåŠ ä¸Šäº† hostname å’Œ service å­—æ®µã€‚

æ¥ç€ï¼Œå®ƒè¿›å…¥äº†å…³é”®çš„ <filter \*\*> è§£æå™¨ã€‚è¿™ä¸ªè§£æå™¨è¢«é…ç½®ä¸º @type json å¹¶ key_name logã€‚

é—®é¢˜å‘ç”Ÿï¼šè§£æå™¨å°è¯•å°† log å­—æ®µçš„å€¼ï¼ˆâ€œã€Docker é©±åŠ¨æµ‹è¯•ã€‘...â€ è¿™æ®µçº¯æ–‡æœ¬ï¼‰å½“ä½œ JSON æ ¼å¼æ¥è§£æã€‚è¿™æ˜¾ç„¶ä¼šå¤±è´¥ã€‚

è®©è§£æå™¨â€œå®½å®¹â€ä¸€äº›ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰

å¦‚æœç¯å¢ƒä¸­æœ‰å¤šç§æ—¥å¿—æ ¼å¼æ··åˆï¼Œæˆ–è€…ä½ æ— æ³•é¢„å…ˆçŸ¥é“æ‰€æœ‰æ ‡ç­¾ï¼Œå¯ä»¥é‡‡ç”¨æ›´â€œå®½å®¹â€çš„é€šç”¨è§„åˆ™ï¼Œå¹¶é€šè¿‡å‚æ•°é˜²æ­¢è¯¯ä¼¤ã€‚

```
<filter **>
  @type parser
  key_name log
  reserve_data true
  suppress_parse_error_log true    # æŠ‘åˆ¶è§£æé”™è¯¯çš„è­¦å‘Šæ—¥å¿—
  emit_invalid_record_to_error false # é‡è¦ï¼šé˜²æ­¢æ— æ•ˆè®°å½•è¢«ä¸¢å¼ƒ
  <parse>
    @type json
  </parse>
</filter>
```

# docker run -d -p 8080:80 -p 8444:444 --name serilog_structured_test --log-driver=fluentd --log-opt fluentd-address=localhost:24224

é‚£å°±æ˜¯è¯´è¿è¡Œå®¹å™¨çš„æ—¶å€™ éƒ½è¦è¿™ä¹ˆæŒ‡å®š logdriver å—

ä¸ºäº†ä¸è¦æ€»æŒ‡å®š logdriver

```
my_net_app:
    image: helloworld:serilog-structured
    container_name: my_net_app_prod
    ports:
      - "8080:80"
      - "8444:444"
    # æ ¸å¿ƒé…ç½®ï¼šåœ¨è¿™é‡Œç»Ÿä¸€è®¾ç½®æ—¥å¿—é©±åŠ¨
    logging:
      driver: "fluentd"
      options:
        fluentd-address: "localhost:24224"
        # å¯ä»¥æ·»åŠ æ›´å¤šæ ‡ç­¾ï¼Œæ–¹ä¾¿åœ¨Fluentdä¸­è·¯ç”±
        tag: "prod.app.{{.Name}}"
    # ç¡®ä¿ä¸Fluentdåœ¨åŒä¸€ä¸ªç½‘ç»œï¼Œæ‰èƒ½ç”¨localhostè®¿é—®
    networks:
      - elastic
```

# æ­¤å¤„æœ¬åœ°éƒ¨ç½²æµ‹è¯• log ç¨‹åº my_net_app é—®é¢˜

ä»£ç åœ¨ï¼šD:\Code\1.microservice\7.netcore_microservice_monitor\helloworld
éƒ¨ç½²åœ¨ï¼šD:\Code\1.microservice\7.netcore_microservice_monitor\docker-compose.yml

https://localhost:8444/WeatherForecast/api/testlog
ç”Ÿæˆçš„ Elastic çš„ index ä¸ºä»€ä¹ˆ åªæœ‰ä¸€ä¸ª 0 å·åˆ†ç‰‡ï¼Œä¸»åˆ†ç‰‡å’Œå‰¯æœ¬åˆ†ç‰‡

```
http://localhost:9200/_cat/shards/fluentd-2025.12.31?v&h=index,shard,prirep,state,node,store&s=shard,prirep
index              shard prirep state   node      store
fluentd-2025.12.31 0     p      STARTED es-data1 22.4kb
fluentd-2025.12.31 0     r      STARTED es-data2 22.5kb

```

# æ–¹æ¡ˆ

é—®é¢˜åˆ†æ
Fluentd ä½¿ç”¨ logstash_format true æ—¶ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºæŒ‰æ—¥æœŸå‘½åçš„ç´¢å¼•ï¼ˆå¦‚ fluentd-2025.12.31ï¼‰ï¼Œå¹¶ä½¿ç”¨ Elasticsearch çš„é»˜è®¤æ¨¡æ¿è®¾ç½®ï¼ˆé€šå¸¸æ˜¯ 1 ä¸»åˆ†ç‰‡ 1 å‰¯æœ¬ï¼‰ã€‚

è§£å†³æ–¹æ¡ˆ
æœ‰å‡ ç§æ–¹å¼å¯ä»¥æ§åˆ¶ Fluentd è‡ªåŠ¨åˆ›å»ºç´¢å¼•çš„åˆ†ç‰‡é…ç½®ï¼š
æ–¹æ¡ˆ 2ï¼šåœ¨ Fluentd é…ç½®ä¸­æŒ‡å®šç´¢å¼•æ¨¡æ¿

æ–¹æ¡ˆ 3ï¼šç›´æ¥è®¾ç½®ç´¢å¼•è®¾ç½®
å¦‚æœä½ ä¸æƒ³ä½¿ç”¨æ¨¡æ¿ï¼Œå¯ä»¥åœ¨ Fluentd ä¸­ç›´æ¥è®¾ç½®ï¼š

```
<match **>
  @type elasticsearch
  host es-master
  port 9200
  logstash_format true
  logstash_prefix fluentd
  number_of_shards 2      # ç›´æ¥è®¾ç½®åˆ†ç‰‡æ•°
  number_of_replicas 1    # ç›´æ¥è®¾ç½®å‰¯æœ¬æ•°
  flush_interval 5s
</match>
```

## æˆ‘æƒ³é€‰æ–¹æ¡ˆ 3 è¿™ä¸ªæ–¹å¼ä¸èƒ½å·¥ä½œ

docker-compose restart fluentd

Fluentd çš„ elasticsearch è¾“å‡ºæ’ä»¶ç¡®å®ä¸æ”¯æŒç›´æ¥åœ¨é…ç½®ä¸­è®¾ç½® number_of_shards å’Œ number_of_replicas å‚æ•°ã€‚è¿™æ˜¯æˆ‘çš„é”™è¯¯ï¼Œæˆ‘éœ€è¦æ›´æ­£ã€‚

## é€‰æ–¹æ¡ˆ 2

1. é¦–é€‰æ–¹æ¡ˆï¼šåˆ›å»ºç´¢å¼•æ¨¡æ¿ï¼ˆå¿…é¡»ä½¿ç”¨ï¼‰
   è¿™æ˜¯å”¯ä¸€å¯é çš„æ–¹æ³•ã€‚é€šè¿‡ Postman æˆ– Kibana Dev Tools æ‰§è¡Œï¼š

```
PUT /_index_template/fluentd_template
{
  "index_patterns": ["fluentd-*"],
  "template": {
    "settings": {
      "number_of_shards": 2,
      "number_of_replicas": 1,
      "refresh_interval": "30s"
    }
  },
  "priority": 100
}
```

éªŒè¯æ¨¡æ¿å·²åˆ›å»ºï¼š

```
GET /_index_template/fluentd_template

```

2. ä¿®æ”¹ Fluentd é…ç½®ä½¿å…¶æ”¯æŒæ¨¡æ¿
   ä¿®æ”¹ä½ çš„ Fluentd é…ç½®æ–‡ä»¶:

```
<match **>
  @type elasticsearch
  host es-master
  port 9200
  logstash_format true
  logstash_prefix fluentd

  # æ·»åŠ æ¨¡æ¿é…ç½®
  template_name "fluentd_template"  # æŒ‡å®šæ¨¡æ¿åç§°
  template_overwrite true           # å…è®¸è¦†ç›–å·²å­˜åœ¨çš„æ¨¡æ¿

  # å¯é€‰ï¼šå¦‚æœæ¨¡æ¿ä¸å­˜åœ¨ï¼Œå¯ä»¥å†…è”å®šä¹‰
  # customize_template '{"index_patterns":["fluentd-*"],"template":{"settings":{"number_of_shards":2,"number_of_replicas":1}}}'

  flush_interval 5s
</match>
```

3. å®Œæ•´éªŒè¯æ­¥éª¤

```
# 1. åˆ é™¤ç°æœ‰ç´¢å¼•ï¼ˆè®©Fluentdé‡æ–°åˆ›å»ºï¼‰
DELETE /fluentd-2025.12.31

# 2. ç¡®ä¿æ¨¡æ¿å­˜åœ¨
GET /_index_template/fluentd_template

# å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒï¼š
PUT /_index_template/fluentd_template
{
  "index_patterns": ["fluentd-*"],
  "template": {
    "settings": {
      "number_of_shards": 3,
      "number_of_replicas": 1
    }
  }
}

# 3. é‡å¯Fluentd
docker-compose restart fluentd

# 4. ç”Ÿæˆæ—¥å¿—ï¼ˆè®¿é—®ä½ çš„åº”ç”¨ï¼‰
# è®¿é—®ï¼šhttps://localhost:8444/WeatherForecast/api/testlog

# 5. éªŒè¯æ–°ç´¢å¼•çš„åˆ†ç‰‡é…ç½®
GET /fluentd-2025.12.31/_settings

# 6. æŸ¥çœ‹åˆ†ç‰‡åˆ†å¸ƒ
GET /_cat/shards/fluentd-2025.12.31?v
```

## é—®é¢˜

è¿™ä¸ªæ¨¡æ¿æ˜¯å­˜å‚¨åœ¨äº†å“ªé‡Œï¼Œæ˜¯ Elastic search ä¸­çš„å—ï¼Ÿ

æ˜¯çš„ï¼Œç´¢å¼•æ¨¡æ¿æ˜¯å­˜å‚¨åœ¨ Elasticsearch é›†ç¾¤ä¸­çš„ï¼Œå…·ä½“æ¥è¯´æ˜¯å­˜å‚¨åœ¨é›†ç¾¤çŠ¶æ€ï¼ˆCluster Stateï¼‰ä¸­ã€‚

```
# æŸ¥çœ‹æ‰€æœ‰æ¨¡æ¿
GET /_index_template

# æŸ¥çœ‹ç‰¹å®šæ¨¡æ¿
GET /_index_template/fluentd_template

```

æŸ¥çœ‹åˆ†ç‰‡åˆ†å¸ƒ

```
http://localhost:9200/_cat/shards/fluentd-2026.01.03?v&h=index,shard,prirep,state,node,store&s=shard,prirep

index              shard prirep state   node     store
fluentd-2026.01.03 0     p      STARTED es-data1  227b
fluentd-2026.01.03 0     r      STARTED es-data2  227b
fluentd-2026.01.03 1     p      STARTED es-data2  227b
fluentd-2026.01.03 1     r      STARTED es-data1  227b
fluentd-2026.01.03 2     p      STARTED es-data1 6.8kb
fluentd-2026.01.03 2     r      STARTED es-data2 6.9kb

```

æ»¡è¶³é¢„æœŸ
