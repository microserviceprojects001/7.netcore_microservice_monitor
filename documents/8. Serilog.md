# æ„å»º Serilog æµ‹è¯•ç¨‹åº

dotnet new webapi -n helloworld --use-controllers

docker build -t helloworld:serilog_1 .
docker run -d -p 8080:80 -p 8444:444 --name serilogtest helloworld:serilog_1

## æŒ‡å®š log driver

docker run -d -p 8080:80 -p 8444:444 --name serilogtest_1 --log-driver=fluentd --log-opt fluentd-address=localhost:24224 helloworld:serilog_1

å¯è®¿é—®ï¼š
https://localhost:8444/WeatherForecast
https://localhost:8444/WeatherForecast/api/testlog

æ˜¯å¯ä»¥åœ¨ kibana ä¸­çœ‹åˆ° log ç»“æœçš„
http://localhost:5601/app/discover#/

# ç°åœ¨é›†æˆ Serilog

æ¥è¾“å‡ºç»“æ„åŒ–ã€æ˜“æŸ¥è¯¢çš„ JSON æ—¥å¿—æ˜¯ç»å¯¹æ­£ç¡®çš„é€‰æ‹©ï¼Œè¿™å°†æå¤§æå‡åœ¨ Kibana ä¸­çš„æ—¥å¿—åˆ†æä½“éªŒ

dotnet add package Serilog.Sinks.Console
dotnet add package Serilog.AspNetCore

# ğŸ”§ ï¼ˆå¯é€‰ï¼‰ç”Ÿäº§çº§å¢å¼ºé…ç½®

å¦‚æœä½ å¸Œæœ›å¯¹æ—¥å¿—çº§åˆ«ã€è¾“å‡ºæ¨¡æ¿ç­‰æœ‰æ›´ç²¾ç»†çš„æ§åˆ¶ï¼Œå¯ä»¥åœ¨ appsettings.json ä¸­æ·»åŠ  Serilog é…ç½®èŠ‚ã€‚é¦–å…ˆï¼Œè¯·ç¡®ä¿åœ¨é¡¹ç›®ä¸­å®‰è£…å¯é€‰åŒ…ï¼š

```
dotnet add package Serilog.Settings.Configuration
```

docker build -t helloworld:serilog-structured .
docker run -d -p 8080:80 -p 8444:444 --name serilog_structured_test --log-driver=fluentd --log-opt fluentd-address=localhost:24224 helloworld:serilog-structured

# é—®é¢˜

kibana ä¸­ä¸èƒ½å¾ˆå¿«æ‰¾åˆ° log çº§åˆ«ï¼Œå•ç‹¬æˆåˆ—

è¿™æ˜¯è¿™ç›´æ¥ postman æŸ¥è¯¢ ES å¾—åˆ°çš„è®°å½•

```
http://localhost:9200/fluentd-2025.12.21/_search?pretty
 {
                "_index": "fluentd-2025.12.21",
                "_id": "SKO0QJsB9C1BH-C6t-G9",
                "_score": 1.0,
                "_ignored": [
                    "log.keyword"
                ],
                "_source": {
                    "log": "{\"Timestamp\":\"2025-12-21T11:38:58.5478891+00:00\",\"Level\":\"Warning\",\"MessageTemplate\":\"è­¦å‘Šçº§åˆ«ï¼šè¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿè­¦å‘Š\",\"TraceId\":\"082db9623f30859db9cd8f10f7468c2d\",\"SpanId\":\"eb1bfc35880d19ba\",\"Properties\":{\"SourceContext\":\"helloworld.Controllers.WeatherForecastController\",\"ActionId\":\"cb9442d2-3b2d-4923-beea-331df78f6633\",\"ActionName\":\"helloworld.Controllers.WeatherForecastController.TestLog (helloworld)\",\"RequestId\":\"0HNI0FRVV05SP:00000001\",\"RequestPath\":\"/WeatherForecast/api/testlog\",\"ConnectionId\":\"0HNI0FRVV05SP\"}}",
                    "container_id": "cad31e3b529cd886d0817f2abb9eb3371004ac260983b7622d2d7a6f87e27d7e",
                    "container_name": "/serilog_structured_test",
                    "source": "stdout",
                    "hostname": "eab99972c779",
                    "service": "my_windows_app",
                    "@timestamp": "2025-12-21T11:38:58.000000000+00:00"
                }
            },
```

æ‚¨çš„ Fluentd é…ç½®æ²¡æœ‰é—®é¢˜ï¼Œä½†ä¸å®Œæ•´ã€‚å®ƒç¼ºå°‘äº†ä¸€ä¸ªæœ€å…³é”®çš„æ­¥éª¤ï¼šè§£ææ¥è‡ª Docker çš„ã€åŒ…è£¹åœ¨ log å­—æ®µä¸­çš„ JSON å­—ç¬¦ä¸²ã€‚

å› ä¸ºæ‚¨çš„æ—¥å¿—è™½ç„¶ä»¥ JSON æ ¼å¼è¾“å‡ºï¼Œä½† Docker çš„ fluentd é©±åŠ¨å°†å…¶ä½œä¸ºä¸€ä¸ªæ•´ä½“æ–‡æœ¬æ¶ˆæ¯å‘é€ï¼Œå¯¼è‡´åœ¨ Elasticsearch ä¸­å®ƒè¢«å­˜å‚¨ä¸ºä¸€ä¸ªåä¸º log çš„å­—ç¬¦ä¸²å­—æ®µã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ Level ç­‰å­—æ®µåœ¨ Kibana ä¸­â€œéšèº«â€äº†ã€‚

è¿™æ˜¯å› ä¸º flentd é…ç½®æ–‡ä»¶ å†³å®šçš„ï¼Œéœ€è¦ç ”ç©¶ fluent.conf æ–‡ä»¶çš„é…ç½®

```
<filter **>
  @type parser
  key_name log
  reserve_data true
  remove_key_name_field false
  <parse>
    @type json
  </parse>
</filter>
```

åŠ ä¸Šè¿™ä¸ªå work äº†

# docker run --rm --log-driver=fluentd --log-opt fluentd-address=localhost:24224 registry.cn-hangzhou.aliyuncs.com/abelcontainer/alpine:3.19.1 echo "ã€Docker é©±åŠ¨æµ‹è¯•ã€‘è¿™æ˜¯ä¸€æ¡é€šè¿‡å®¹å™¨æ ‡å‡†è¾“å‡ºç”Ÿæˆçš„æ—¥å¿—" è¿™ä¸ªæ–¹å¼çš„ æ—¥å¿—ï¼Œæ€ä¹ˆæ‰¾ä¸åˆ°äº†å‘¢

Fluentd çš„å¤„ç†æµç¨‹ï¼š

è¿™æ¡çº¯æ–‡æœ¬è¢« Docker é©±åŠ¨æ•è·ï¼Œæ”¾å…¥ log å­—æ®µå‘é€ç»™ Fluentdã€‚

æ—¥å¿—è¿›å…¥ \*\* è¿‡æ»¤å™¨é“¾ï¼Œç¬¬ä¸€ä¸ª record_transformer ä¸ºå®ƒåŠ ä¸Šäº† hostname å’Œ service å­—æ®µã€‚

æ¥ç€ï¼Œå®ƒè¿›å…¥äº†å…³é”®çš„ <filter \*\*> è§£æå™¨ã€‚è¿™ä¸ªè§£æå™¨è¢«é…ç½®ä¸º @type json å¹¶ key_name logã€‚

é—®é¢˜å‘ç”Ÿï¼šè§£æå™¨å°è¯•å°† log å­—æ®µçš„å€¼ï¼ˆâ€œã€Docker é©±åŠ¨æµ‹è¯•ã€‘...â€ è¿™æ®µçº¯æ–‡æœ¬ï¼‰å½“ä½œ JSON æ ¼å¼æ¥è§£æã€‚è¿™æ˜¾ç„¶ä¼šå¤±è´¥ã€‚

è®©è§£æå™¨â€œå®½å®¹â€ä¸€äº›ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰

å¦‚æœç¯å¢ƒä¸­æœ‰å¤šç§æ—¥å¿—æ ¼å¼æ··åˆï¼Œæˆ–è€…ä½ æ— æ³•é¢„å…ˆçŸ¥é“æ‰€æœ‰æ ‡ç­¾ï¼Œå¯ä»¥é‡‡ç”¨æ›´â€œå®½å®¹â€çš„é€šç”¨è§„åˆ™ï¼Œå¹¶é€šè¿‡å‚æ•°é˜²æ­¢è¯¯ä¼¤ã€‚

```
<filter **>
  @type parser
  key_name log
  reserve_data true
  suppress_parse_error_log true    # æŠ‘åˆ¶è§£æé”™è¯¯çš„è­¦å‘Šæ—¥å¿—
  emit_invalid_record_to_error false # é‡è¦ï¼šé˜²æ­¢æ— æ•ˆè®°å½•è¢«ä¸¢å¼ƒ
  <parse>
    @type json
  </parse>
</filter>
```
