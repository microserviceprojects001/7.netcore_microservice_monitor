# 构建 Dockerfile 文件

# 构建镜像

docker build -f User.API/Dockerfile -t registry.cn-hangzhou.aliyuncs.com/microsoftservice/user.api:v1 .

此时数据库配置是使用的

```
"ConnectionStrings": {
    "MySQL": "Server=db;port=3306;Database=beta_user;User=abel;Password=acsdev312!@"
  },
```

# 问题报错

去执行 docker build -f User.API/Dockerfile -t registry.cn-hangzhou.aliyuncs.com/microsoftservice/user.api:v1 . 命令报错，不能构建镜像成功 => ERROR [build-env 13/13] RUN dotnet publish -c Release -o /app/out 41.7s

---

> [build-env 13/13] RUN dotnet publish -c Release -o /app/out:

5.662 Determining projects to restore...

5.718 Skipping project "/src/Microservice.Contracts/Microservice.Contracts.csproj" because it was not found.

6.436 Skipping project "/src/Microservice.Contracts/Microservice.Contracts.csproj" because it was not found.

13.90 Restored /src/BuildingBlocks/Resilience/Resilience.csproj (in 3.01 sec).

14.32 Restored /src/User.API/User.API.csproj (in 3.86 sec).

14.46 /usr/share/dotnet/sdk/9.0.203/Current/SolutionFile/ImportAfter/Microsoft.NET.Sdk.Solution.targets(36,5): warning NETSDK1194: The "--output" option isn't supported when building a solution. Specifying a solution-level output path results in all projects copying outputs to the same directory, which can lead to inconsistent builds. [/src/User.API/User.API.sln]

# 原因

其实是因为我的代码中引用了 Microservice.Contracts.csproj 工程，然而我的 Dockerfile 中并没有加载这个工程，所以报错

# 先手动启动容器

应用本地默认网络的数据库 UserApiMysql001 做链接测试

docker run -d -p 7025:80 -p 8443:443 --link UserApiMysql001:db --name userapi-api registry.cn-hangzhou.aliyuncs.com/microsoftservice/user.api:v1

docker logs -f userapi-api
容器中查看到报错信息如下：

```
fail: User.API.Services.ConsulRegistrationService[0]
      ❌ 注册服务到Consul失败: https://[::]:443
      System.Net.Http.HttpRequestException: Name or service not known (consul:8500)
       ---> System.Net.Sockets.SocketException (0xFFFDFFFF): Name or service not known
         at System.Net.Sockets.Socket.AwaitableSocketAsyncEventArgs.ThrowException(SocketError error, CancellationToken cancellationToken)
```

我想原因是 consul 的容器所在网络是和 userapi-api 所属网络不同，所以找不到

问题确实是网络隔离。consul 容器在 DeployCommon 的 elastic 网络中，而 userapi-api 容器使用默认网络，无法访问 consul:8500。
userapi-api 属于是废弃的容器了，我并不想在额外开一个本地 consul 服务
此时本地测试和线上环境冲突了，如果想要本地能功能工作，那就需要处理一下

consul 容器化部署修改一下端口到 8700

```
  consul:
    image: registry.cn-hangzhou.aliyuncs.com/abelcontainer/consul:latest
    container_name: consul
    ports:
      - "8700:8500"  # Web UI
    command: >
      agent -server -bootstrap-expect=1
      -ui -bind=0.0.0.0 -client=0.0.0.0
    volumes:
      - consul-data:/consul/data
    networks:
      - elastic
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8500/v1/status/leader"]
      interval: 30s
      timeout: 10s
      retries: 3
```

这样线上环境可以用 http://localhost:8700/ui/dc1/services 去跟踪情况

线下仍然可以启动
D:\Code\1.microservice\4.netcore_microservice_ocelot_consul_discoveryservice\consul_1.21.3_windows_amd64>consul agent --dev
用 http://localhost:8500/ui/dc1/services 跟踪情况

userapi-api 不 work， 容器先扔那了，他的应用镜像属于线上的配置了，本地开发测试是不受影响的

用 Docker-compose 部署服务

# mysql 设置

现在是需要进入到容器中
这样的设置放在数据库初始化脚本里面

默认用户添加
D:\Code\1.microservice\2.netcore_microservice_userService\DeployCommon\mysql-init\init.sql
字符集挂载
D:\Code\1.microservice\2.netcore_microservice_userService\DeployCommon\config\mysql\my.cnf

当启动容器时候执行 用户的添加

```

-- 1. 创建用户并设置密码（注意密码中的特殊字符需要用引号包裹）
CREATE USER 'abel'@'%' IDENTIFIED BY 'acsdev312!@';

-- 2. 授予权限（这里授予所有数据库的所有权限，按需调整）
GRANT ALL PRIVILEGES ON *.* TO 'abel'@'%' WITH GRANT OPTION;

-- 3. 刷新权限使更改生效
FLUSH PRIVILEGES;

```

做验证

```
docker exec -it mysql-deploy bash
mysql -uabel -p
acsdev312!@

SHOW VARIABLES LIKE '%char%';
+--------------------------+--------------------------------+
| Variable_name            | Value                          |
+--------------------------+--------------------------------+
| character_set_client     | utf8mb4                        |
| character_set_connection | utf8mb4                        |
| character_set_database   | utf8mb4                        |
| character_set_filesystem | binary                         |
| character_set_results    | utf8mb4                        |
| character_set_server     | utf8mb4                        |
| character_set_system     | utf8mb3                        |
| character_sets_dir       | /usr/share/mysql-9.3/charsets/ |

mysql> use mysql
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql> select user.user, user.host from user;
+------------------+-----------+
| user             | host      |
+------------------+-----------+
| abel             | %         |
| root             | %         |
| mysql.infoschema | localhost |
| mysql.session    | localhost |
| mysql.sys        | localhost |
| root             | localhost |
+------------------+-----------+
6 rows in set (0.001 sec)
```

关键区别
/etc/my.cnf：MySQL 的全局主配置文件

/etc/mysql/conf.d/：额外的配置文件目录

:ro 是 read-only 的缩写，表示只读挂载。

# linux 权限

1. 权限位表示

```
   -rwxr-xr-x 1 user group 4096 Jan  3 12:00 file.txt
    ↑↑↑↑↑↑↑↑↑
    │││││││││
    ││││││││└─ 其他用户的执行权限 (x)
    │││││││└── 其他用户的写权限 (-)
    ││││││└─── 其他用户的读权限 (r)
    │││││└──── 所属组的执行权限 (x)
    ││││└───── 所属组的写权限 (-)
    │││└────── 所属组的读权限 (r)
    ││└─────── 所有者的执行权限 (x)
    │└──────── 所有者的写权限 (w)
    └───────── 所有者的读权限 (r)
```

2. 权限类型
   权限 字符 数字 对文件的意义 对目录的意义
   读 r 4 查看文件内容 列出目录内容 (ls)
   写 w 2 修改文件内容 创建/删除/重命名文件
   执行 x 1 执行文件（程序/脚本） 进入目录 (cd)

# 至此 mysql 容器已启动，

账户信息
root
acsdev312

abel
acsdev312!@

dotnet ef database update -c RecommendDBContext
