![alt text](<../截图/5. fluentd.png>)

# 安装

https://docs.fluentd.org/quickstart

```
  fluentd:
    image: fluent/fluentd:v1.16-1
    container_name: fluentd
    volumes:
      # Windows路径：挂载当前目录下的 fluentd/conf 文件夹作为配置目录
      - ./fluentd/conf:/fluentd/etc
      # 挂载日志目录，用于收集Web应用产生的日志文件
      - ./logs:/var/log
    ports:
      - "24224:24224"
      - "24224:24224/udp"
    networks:
      - elastic
    depends_on:
      - es-master
    mem_limit: 500m
```

# 创建存放 Fluentd 配置的文件夹

mkdir fluentd
mkdir fluentd\conf

# 创建存放日志文件的文件夹（Web 应用日志可输出到这里）

mkdir logs

# 关键配置修改 （没这么做，用的还是 es-master）

关键调整说明：配置文件中最重要的一行是将 host 从 es-master 改为 host.docker.internal。在 Windows Docker Desktop 中，这是容器内部访问宿主机服务的特殊 DNS 名称，可以成功连接到您宿主机上映射出的 localhost:9200

host.docker.internal 是一个在 Windows 和 macOS 系统的 Docker Desktop 环境中固定的、特殊的 DNS 名称，专门用于让容器内部的网络访问宿主机（即您的 Windows 电脑本身） 上运行的服务。
为什么在这里必须使用 host.docker.internal？
让我们对比一下两种配置方式的网络逻辑，您就能完全理解其必要性：

```

配置方式	                             网络流向	                                                                         结果与原因
host: es-master	                       Fluentd 容器 → (Docker网络) → ES 容器 (es-master)	                            失效。因为您的 ES 集群是通过宿主机端口映射（9200:9200）暴露的，es-master 容器本身只监听在 Docker 内部网络（如 172.20.0.2:9200），并未直接对
                                                                                                                           host.docker.internal 这个“宿主机模拟网络”提供服务。
host: host.docker.internal	           Fluentd 容器 → (Docker特殊桥接) → Windows 宿主机 (localhost) → (端口映射) → ES 容器	成功。host.docker.internal 指向宿主机的网络栈。当请求到达宿主机的 9200 端口时，Docker 的端口映射规则（-p 9200:9200）会将其转发到 es-master 容器的 9200 端口。
```

docker pull registry.cn-hangzhou.aliyuncs.com/abelcontainer/fluentd:v1.16-1 # 有问题

# 启动容器

docker-compose up -d fluentd

# 容器启动后 log 报错

```
2025-12-21 00:30:41 +0000 [error]: config error file="/fluentd/etc/fluent.conf" error_class=Fluent::NotFoundPluginError error="Unknown output plugin 'elasticsearch'. Run 'gem search -rd fluent-plugin' to find plugins"
```

容器无法启动原因是 镜像里插件不够导致的，所以更换镜像

docker pull registry.cn-hangzhou.aliyuncs.com/abelcontainer/fluentd-kubernetes-daemonset:v1.16.3-debian-elasticsearch8-1.0

# 验证操作

好了，现在可以了，fluentd 容器已经启动，我想做一些验证，比方说 fluentd 能否和 es 联通
docker exec -it fluentd bash
apt-get update && apt-get install -y telnet netcat-openbsd

```
root@ea771b680f31:/home/fluent# telnet es-master 9200
Trying 172.21.0.2...
Connected to es-master. 证明应该是可以的了
```

# windows powershell 做测试

PS C:\Users\Abel> curl.exe -X POST http://localhost:24224/my.test -H "Content-Type: application/json" -d '{"message":"Fluentd 集成连通性测试", "timestamp":"'"$(Get-Date -Format 'yyyy-MM-ddTHH:mm:ss')"'", "test": true}'

报错

```
fluentd  | 2025-12-21 02:11:15 +0000 [warn]: #0 incoming chunk is broken: host="172.21.0.1" msg=100
fluentd  | 2025-12-21 02:11:15 +0000 [warn]: #0 incoming chunk is broken: host="172.21.0.1" msg=-23
```

docker-compose restart fluentd
docker-compose logs --tail 5 fluentd

# 放弃 windows powershell 方式，换方式做测试（可以工作）

docker pull registry.cn-hangzhou.aliyuncs.com/abelcontainer/alpine:3.19.1

docker run --rm --log-driver=fluentd --log-opt fluentd-address=localhost:24224 registry.cn-hangzhou.aliyuncs.com/abelcontainer/alpine:3.19.1 echo "【Docker 驱动测试】这是一条通过容器标准输出生成的日志"

是可以在 http://localhost:5601/app/home
discover 中查到对应结果的

# 以上初步完成 fluentd 到查看调试
